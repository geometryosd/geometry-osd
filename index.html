<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Stranger Dash: Legendary Mobile Edition V35</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff0000">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@900&display=swap');
        :root { --primary: #ff0000; --glow: #e31b23; --success: #2ecc71; }
        
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Segoe UI', sans-serif; 
            color: white; 
            user-select: none; 
            touch-action: none;
            width: 100vw;
            height: 100vh;
        }
        
        body::after {
            content: " "; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.05), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.05));
            background-size: 100% 4px, 3px 100%; pointer-events: none; z-index: 1000; opacity: 0.3;
        }

        #game-ui { position: absolute; top: 20px; left: 20px; color: var(--primary); font-size: clamp(18px, 5vw, 32px); font-weight: 900; z-index: 10; display: none; font-family: 'Crimson Pro', serif; text-shadow: 0 0 10px var(--glow); }
        .stats-top { position: absolute; top: 20px; right: 20px; color: #ffd700; font-size: clamp(14px, 4vw, 24px); z-index: 110; background: rgba(0,0,0,0.8); padding: 8px 15px; border: 2px solid var(--glow); box-shadow: inset 0 0 10px var(--glow); border-radius: 5px; }

        #mobile-controls { 
            position: absolute; bottom: 30px; width: 100%; 
            display: none; justify-content: space-between; 
            padding: 0 30px; box-sizing: border-box; z-index: 2000; 
            pointer-events: none; 
        }
        .m-btn { 
            width: clamp(80px, 15vw, 120px); 
            height: clamp(80px, 15vw, 120px); 
            background: rgba(0,0,0,0.8); 
            border: 4px solid var(--glow); 
            border-radius: 50%; color: white; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 900; font-family: 'Crimson Pro', serif; 
            font-size: clamp(16px, 4vw, 24px); 
            box-shadow: 0 0 20px var(--glow); 
            pointer-events: auto; cursor: pointer; 
        }
        .m-btn:active { transform: scale(0.85); background: var(--glow); }

        #ui-overlay { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            z-index: 500; background: rgba(0,0,0,0.92); 
            backdrop-filter: blur(10px); 
        }
        .menu-card { 
            padding: 25px; 
            border: 4px solid var(--glow); 
            box-shadow: 0 0 40px var(--glow); 
            width: 90%; 
            max-width: 600px; 
            max-height: 90vh; 
            background: black; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-y: auto; 
        }
        .menu-title { font-family: 'Crimson Pro', serif; font-size: clamp(35px, 10vw, 65px); color: var(--primary); text-transform: uppercase; margin-bottom: 20px; text-shadow: 0 0 20px var(--glow); letter-spacing: -2px; text-align: center; }

        .tabs { display: flex; width: 100%; border-bottom: 2px solid var(--glow); margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 10px; background: transparent; border: none; color: #555; cursor: pointer; font-family: 'Crimson Pro', serif; font-size: clamp(12px, 3vw, 18px); text-transform: uppercase; }
        .tab-btn.active { color: var(--primary); text-shadow: 0 0 10px var(--glow); }

        .content-box { width: 100%; min-height: 200px; }
        .row { display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 10px 0; border-bottom: 1px solid rgba(227, 27, 35, 0.3); }
        .display-text { font-family: 'Crimson Pro', serif; font-size: clamp(20px, 5vw, 30px); color: white; text-transform: uppercase; text-align: center; flex: 1; }
        
        .arrow-btn { background: transparent; border: 2px solid var(--glow); color: var(--glow); width: 45px; height: 45px; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; }
        .main-btn { width: 100%; padding: 18px; background: transparent; border: 3px solid var(--glow); color: var(--primary); font-size: clamp(20px, 6vw, 32px); font-family: 'Crimson Pro', serif; margin-top: 20px; cursor: pointer; text-transform: uppercase; }
        .save-btn { width: 100%; padding: 8px; background: transparent; border: 1px solid var(--success); color: var(--success); font-family: 'Crimson Pro', serif; margin-top: 10px; cursor: pointer; text-transform: uppercase; font-size: 12px; }

        .volume-row { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }
        input[type=range] { width: 50%; cursor: pointer; accent-color: var(--primary); }

        .tag { position: absolute; bottom: 160px; left: 50%; transform: translateX(-50%); padding: 10px 30px; background: black; border: 2px solid var(--glow); font-family: 'Crimson Pro', serif; font-size: 20px; display: none; z-index: 100; white-space: nowrap; }
        .tag.active { border-color: #00ff00; color: #00ff00; box-shadow: 0 0 30px #00ff00; }
        .tag.cooldown { border-color: #555; color: #555; }
        .hidden { display: none !important; }
        .skin-card { padding: 10px; border: 1px solid #333; cursor: pointer; text-align: center; font-size: 14px; }
        .skin-card.selected { border-color: var(--success); color: var(--success); }
    </style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="music.mp3" type="audio/mpeg">
    </audio>

    <div id="game-ui">SCORE: 0 | üí∞: 0</div>
    <div class="stats-top">üí∞ <span id="wallet-balance">0</span></div>

    <div id="mobile-controls">
        <div class="m-btn" id="m-jump">JUMP</div>
        <div class="m-btn" id="m-ability">E</div>
    </div>

    <div id="ui-overlay">
        <div class="menu-card">
            <div class="menu-title">Stranger Dash</div>
            <div class="tabs">
                <button class="tab-btn active" id="btn-heroes">–ì–µ—Ä–æ–∏</button>
                <button class="tab-btn" id="btn-shop">–ú–∞–≥–∞–∑–∏–Ω</button>
                <button class="tab-btn" id="btn-settings">–û–ø—Ü–∏–∏</button>
                <button class="tab-btn" id="btn-inv">–ê—Ä—Å–µ–Ω–∞–ª</button>
            </div>
            
            <div class="content-box">
                <div id="view-heroes">
                    <div class="row"><button class="arrow-btn" onclick="changeSkin(-1)">‚Üê</button><div class="display-text" id="skin-name">–î–µ–º–æ–ø—ë—Å</div><button class="arrow-btn" onclick="changeSkin(1)">‚Üí</button></div>
                    <div class="row"><button class="arrow-btn" onclick="changeWorld(-1)">‚Üê</button><div class="display-text" style="line-height:1"><div id="world-name" style="font-size: 0.8em">–•–æ—É–∫–∏–Ω—Å</div><div id="world-diff-label" style="font-size:10px; font-weight:bold;">EASY</div></div><button class="arrow-btn" onclick="changeWorld(1)">‚Üí</button></div>
                </div>
                <div id="view-shop" class="hidden">
                    <div class="row" id="row-magnet"><span>–ú–∞–≥–Ω–∏—Ç –º–æ–Ω–µ—Ç</span><button class="arrow-btn" style="width:80px; font-size:14px" onclick="buyUpgrade('magnet')">50üí∞</button></div>
                    <div class="row" id="row-multiplier"><span>–£–¥–∞—á–∞ (X2)</span><button id="shop-multiplier" class="arrow-btn" style="width:100px; font-size:14px" onclick="buyUpgrade('multiplier')">100üí∞</button></div>
                </div>
                <div id="view-settings" class="hidden">
                    <div class="row"><span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span><div><button class="arrow-btn" style="width:70px; font-size:12px; display:inline-flex" id="ctrl-pc" onclick="setControl('pc')">–ü–ö</button> <button class="arrow-btn" style="width:70px; font-size:12px; display:inline-flex" id="ctrl-mobile" onclick="setControl('mobile')">–¢–ê–ß</button></div></div>
                    <div class="volume-row">
                        <span style="font-family: 'Crimson Pro'; font-size: 18px;">–ó–í–£–ö</span>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5" oninput="updateVolume(this.value)">
                    </div>
                </div>
                <div id="view-inv" class="hidden"><div id="collection-list" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;"></div></div>
            </div>

            <button class="main-btn" id="main-btn" onclick="handleMainAction()">–ò–ì–†–ê–¢–¨</button>
            <button class="save-btn" onclick="manualSave()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>
    </div>
    <div id="tag-e" class="tag">ABILITY [E]</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const MASTER_KEY = 'STRANGER_DASH_V35_MOBILE_FINAL';
        const music = document.getElementById('bg-music');
        
        let data = JSON.parse(localStorage.getItem(MASTER_KEY)) || {
            wallet: 0, owned: ['–î–µ–º–æ–ø—ë—Å'], selectedSkin: '–î–µ–º–æ–ø—ë—Å', upgrades: { magnet: 0, multiplier: 0 }, controlType: 'pc', volume: 0.5
        };

        const worlds = [
            { name: "–•–æ—É–∫–∏–Ω—Å", fog: 0xa8d8ea, sky: 0x87ceeb, obs: 0x4d2600, speed: 0.18, diff: "EASY", dCol: "#2ecc71", road: 0x333333, theme: "suburb" },
            { name: "Starcourt", fog: 0x110011, sky: 0x020002, obs: 0x00ffff, speed: 0.22, diff: "MEDIUM", dCol: "#f1c40f", road: 0x111111, theme: "mall" },
            { name: "–ò–∑–Ω–∞–Ω–∫–∞", fog: 0x120505, sky: 0x010000, obs: 0xff3300, speed: 0.26, diff: "HARD", dCol: "#e31b23", road: 0x2a0505, theme: "upside" }
        ];

        const skins = [
            { name: "–î–µ–º–æ–ø—ë—Å", price: 0, ability: "–ø—Ä—ã–∂–æ–∫", color: 0x4a2c2a, type: 'monster' },
            { name: "–û–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å", price: 200, ability: "—Å–ª–æ–º", color: 0xffb6c1, type: 'human' },
            { name: "–î–∞—Å—Ç–∏–Ω", price: 100, ability: "–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ", color: 0x2e86c1, type: 'human' },
            { name: "–°—Ç–∏–≤", price: 150, ability: "—â–∏—Ç", color: 0x1a237e, type: 'human' },
            { name: "–í–µ–∫–Ω–∞", price: 800, ability: "–ª–µ–≤–∏—Ç–∞—Ü–∏—è", color: 0x420d0d, type: 'monster' },
            { name: "–¢–í-–ú–∞–Ω", price: 500, ability: "—Ç–µ–ª–µ–ø–æ—Ä—Ç", color: 0x111111, type: 'titan' }
        ];

        let scene, camera, renderer, playerGroup, road, bgGroup;
        let obstacles = [], coins = [], score = 0, sessionCoins = 0, speed = 0.16, dy = 0, gameState = 0;
        let curSkinIdx = 0, curWorldIdx = 0, jumping = false, eReady = true, abilityActive = false;
        let limbs = { lLeg: null, rLeg: null, lArm: null, rArm: null, body: null, head: null, petals: [] };

        function updateVolume(val) { data.volume = val; music.volume = val; }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 3000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 1.3); sun.position.set(10, 20, 10); scene.add(sun);
            bgGroup = new THREE.Group(); scene.add(bgGroup);
            playerGroup = new THREE.Group(); scene.add(playerGroup);
            const roadGeo = new THREE.BoxGeometry(3000, 0.5, 12);
            road = new THREE.Mesh(roadGeo, new THREE.MeshStandardMaterial({ color: 0x333333 }));
            road.position.y = -1.5; scene.add(road);
            camera.position.set(-10, 6, 17); camera.lookAt(3, 0, 0);

            const jBtn = document.getElementById('m-jump');
            const aBtn = document.getElementById('m-ability');
            const handleTouch = (action) => { if(gameState === 1) action(); };
            ['pointerdown'].forEach(evt => {
                jBtn.addEventListener(evt, (e) => { e.preventDefault(); handleTouch(tryJump); });
                aBtn.addEventListener(evt, (e) => { e.preventDefault(); handleTouch(useAbility); });
            });

            music.volume = data.volume;
            document.getElementById('volume-slider').value = data.volume;
            setupTabs(); updateUI(); updateModel(); updateWorld(); gameLoop();
            setControl(data.controlType);
        }

        function createVoxelModel(s) {
            const group = new THREE.Group();
            const mat = (c) => new THREE.MeshStandardMaterial({ color: c });
            limbs.petals = [];
            
            if (s.name === "–î–µ–º–æ–ø—ë—Å") {
                const body = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.8, 0.8), mat(s.color));
                body.position.y = 0.3; limbs.body = body;
                const head = new THREE.Group(); head.position.set(1.0, 0.4, 0);
                for(let i=0; i<5; i++) {
                    const petal = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.15, 0.35), mat(s.color));
                    const piv = new THREE.Group(); piv.rotation.z = i * 1.25; piv.add(petal);
                    petal.position.x = 0.35; head.add(piv); limbs.petals.push(piv);
                }
                body.add(head);
                limbs.lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.6, 0.3), mat(s.color)); 
                limbs.rLeg = limbs.lLeg.clone(); limbs.lArm = limbs.lLeg.clone(); limbs.rArm = limbs.lLeg.clone();
                limbs.lLeg.position.set(-0.7,-0.2,0.4); limbs.rLeg.position.set(-0.7,-0.2,-0.4);
                limbs.lArm.position.set(0.7,-0.2,0.4); limbs.rArm.position.set(0.7,-0.2,-0.4);
                group.add(body, limbs.lLeg, limbs.rLeg, limbs.lArm, limbs.rArm);
            } else if (s.name === "–¢–í-–ú–∞–Ω") {
                const torso = new THREE.Mesh(new THREE.BoxGeometry(0.9, 1.4, 0.6), mat(0x111111));
                torso.position.y = 0.7; limbs.body = torso;
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.8, 0.5), mat(0x222222));
                head.position.y = 1.1; torso.add(head);
                const screen = new THREE.Mesh(new THREE.PlaneGeometry(1, 0.6), new THREE.MeshBasicMaterial({color: 0xaaaaaa}));
                screen.position.set(0.1, 0, 0.26); screen.rotation.y = Math.PI/2; head.add(screen);
                limbs.lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.35, 1, 0.35), mat(0x111111)); limbs.rLeg = limbs.lLeg.clone();
                limbs.lArm = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1.2, 0.3), mat(0x111111)); limbs.rArm = limbs.lArm.clone();
                limbs.lLeg.position.set(-0.25, -0.6, 0); limbs.rLeg.position.set(0.25, -0.6, 0);
                limbs.lArm.position.set(-0.65, 0.5, 0); limbs.rArm.position.set(0.65, 0.5, 0);
                group.add(torso, limbs.lLeg, limbs.rLeg, limbs.lArm, limbs.rArm);
            } else {
                const torso = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.2, 0.5), mat(s.color));
                torso.position.y = 0.6; limbs.body = torso;
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.65, 0.65, 0.65), mat(s.name === "–í–µ–∫–Ω–∞" ? 0x8b3a3a : 0xffdbac));
                head.position.y = 0.95; torso.add(head);
                limbs.lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.9, 0.3), mat(0x222222)); limbs.rLeg = limbs.lLeg.clone();
                limbs.lArm = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.9, 0.25), mat(0xffdbac)); limbs.rArm = limbs.lArm.clone();
                limbs.lLeg.position.set(-0.25, -0.45, 0); limbs.rLeg.position.set(0.25, -0.45, 0);
                limbs.lArm.position.set(-0.55, 0.5, 0); limbs.rArm.position.set(0.55, 0.5, 0);
                group.add(torso, limbs.lLeg, limbs.rLeg, limbs.lArm, limbs.rArm);
            }
            return group;
        }

        function createSmoke(pos) {
            for(let i=0; i<10; i++) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color: 0x555555, transparent: true, opacity: 0.6}));
                p.position.set(pos.x + (Math.random()-0.5)*2, pos.y + (Math.random()-0.5)*2, pos.z);
                scene.add(p);
                const interval = setInterval(() => {
                    p.scale.multiplyScalar(0.9); p.position.y += 0.1;
                    if(p.scale.x < 0.1) { scene.remove(p); clearInterval(interval); }
                }, 30);
            }
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);
            if(gameState === 1) {
                const t = Date.now() * 0.01; const runS = speed * 12;
                if(!jumping) {
                    limbs.lLeg.rotation.x = Math.sin(t * runS) * 0.95; limbs.rLeg.rotation.x = -Math.sin(t * runS) * 0.95;
                    limbs.lArm.rotation.x = -Math.sin(t * runS) * 0.85; limbs.rArm.rotation.x = Math.sin(t * runS) * 0.85;
                    limbs.body.position.y = (skins[curSkinIdx].type === 'monster' ? 0.3 : 0.6) + Math.abs(Math.cos(t * runS)) * 0.16;
                }
                road.position.x -= speed; if(road.position.x < -100) road.position.x = 0;
                playerGroup.position.y += dy; dy -= (abilityActive && skins[curSkinIdx].ability==='–ª–µ–≤–∏—Ç–∞—Ü–∏—è'?0.008:0.038); 
                if(playerGroup.position.y < -0.5) { playerGroup.position.y = -0.5; dy = 0; jumping = false; }

                obstacles.forEach((o, i) => {
                    o.position.x -= speed;
                    const pBox = new THREE.Box3().setFromObject(playerGroup).expandByScalar(-0.3);
                    if(pBox.intersectsBox(new THREE.Box3().setFromObject(o))) {
                        if(abilityActive && (skins[curSkinIdx].ability === '—â–∏—Ç' || skins[curSkinIdx].ability === '—Ç–µ–ª–µ–ø–æ—Ä—Ç')) { 
                            if(skins[curSkinIdx].ability === '—â–∏—Ç') { scene.remove(o); obstacles.splice(i, 1); score += 2; }
                        } else gameOver();
                    }
                    if(o.position.x < -25) { scene.remove(o); obstacles.splice(i, 1); score++; }
                });
                coins.forEach((c, i) => {
                    c.position.x -= speed; c.rotation.y += 0.05;
                    if(playerGroup.position.distanceTo(c.position) < (2.8 + data.upgrades.magnet*2.5)) c.position.lerp(playerGroup.position, 0.2);
                    if(playerGroup.position.distanceTo(c.position) < 1.4) { 
                        let gain = (1 + (data.upgrades.multiplier > 0 ? 1 : 0));
                        sessionCoins += gain; data.wallet += gain; scene.remove(c); coins.splice(i, 1); 
                    }
                });

                if(Math.random() < 0.028) { 
                    const lastX = obstacles.length ? obstacles[obstacles.length-1].position.x : -100;
                    if(100 - lastX > 28) spawnObstacle(); 
                }
                
                if(Math.random() < 0.0025) {
                   const lastC = coins.length ? coins[coins.length-1].position.x : -100;
                   if(100 - lastC > 150) spawnCoin();
                }

                bgGroup.children.forEach(b => { b.position.x -= speed * 0.45; if(b.position.x < -1500) b.position.x = 1500; });
                document.getElementById('game-ui').innerText = `SCORE: ${score} | üí∞: ${sessionCoins}`;
                document.getElementById('wallet-balance').innerText = data.wallet;
            }
            renderer.render(scene, camera);
        }

        function useAbility() {
            if(!eReady || gameState !== 1) return;
            const s = skins[curSkinIdx]; eReady = false; abilityActive = true;
            const tag = document.getElementById('tag-e'); tag.style.display = 'block'; tag.classList.add('active'); tag.innerText = "ACTIVE!";
            
            if(s.ability === '–ø—Ä—ã–∂–æ–∫') { dy = 1.0; jumping = true; abilityActive = false; }
            else if(s.ability === '—Å–ª–æ–º') { 
                const pulse = new THREE.Mesh(new THREE.SphereGeometry(1.2), new THREE.MeshBasicMaterial({color: 0xff00ff, transparent:true, opacity:0.6}));
                playerGroup.add(pulse);
                setTimeout(() => { obstacles.forEach(o => scene.remove(o)); obstacles = []; playerGroup.remove(pulse); abilityActive = false; }, 200);
            }
            else if(s.ability === '–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ') { 
                let os = speed; speed *= 0.4;
                setTimeout(() => { speed = os; abilityActive = false; }, 5000); 
            }
            else if(s.ability === '–ª–µ–≤–∏—Ç–∞—Ü–∏—è') { dy = 0.45; jumping = true; setTimeout(() => { abilityActive = false; }, 4000); }
            else if(s.ability === '—â–∏—Ç') { 
                const vfx = new THREE.Mesh(new THREE.SphereGeometry(1.6), new THREE.MeshBasicMaterial({color:0x00ffff, transparent:true, opacity:0.3})); 
                playerGroup.add(vfx); 
                setTimeout(() => { playerGroup.remove(vfx); abilityActive = false; }, 5000); 
            }
            else if(s.ability === '—Ç–µ–ª–µ–ø–æ—Ä—Ç') {
                createSmoke(playerGroup.position);
                playerGroup.position.x += 15;
                createSmoke(playerGroup.position);
                setTimeout(() => { abilityActive = false; }, 500);
            }

            setTimeout(() => { tag.classList.replace('active', 'cooldown'); tag.innerText = "COOLDOWN"; }, 5000);
            setTimeout(() => { eReady = true; tag.classList.remove('cooldown'); tag.innerText = s.ability.toUpperCase() + " [E]"; }, 15000);
        }

        function tryJump() { if(!jumping && gameState === 1) { dy = 0.85; jumping = true; } }
        function spawnCoin() { const c = new THREE.Mesh(new THREE.TorusGeometry(0.35, 0.1, 8, 16), new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xffaa00 })); c.position.set(100, Math.random()>0.5?4:0, 0); scene.add(c); coins.push(c); }
        function spawnObstacle() { const o = new THREE.Mesh(new THREE.BoxGeometry(1.7, 5, 1.7), new THREE.MeshStandardMaterial({ color: worlds[curWorldIdx].obs })); o.position.set(100, 1.0, 0); scene.add(o); obstacles.push(o); }
        function updateModel() { while(playerGroup.children.length > 0) playerGroup.remove(playerGroup.children[0]); playerGroup.add(createVoxelModel(skins[curSkinIdx])); playerGroup.position.set(-8, -0.5, 0); }
        function handleMainAction() { const s = skins[curSkinIdx]; if(data.owned.includes(s.name)) startGame(); else if(data.wallet >= s.price) { data.wallet -= s.price; data.owned.push(s.name); updateUI(); save(); } }
        
        function startGame() { 
            gameState = 1; score = 0; sessionCoins = 0; speed = worlds[curWorldIdx].speed; dy = 0; jumping = false; eReady = true;
            obstacles.forEach(o => scene.remove(o)); obstacles = []; coins.forEach(c => scene.remove(c)); coins = []; 
            document.getElementById('ui-overlay').classList.add('hidden'); 
            document.getElementById('game-ui').style.display = 'block'; 
            document.getElementById('tag-e').style.display = 'block'; 
            document.getElementById('tag-e').innerText = skins[curSkinIdx].ability.toUpperCase() + " [E]";
            if(data.controlType === 'mobile') document.getElementById('mobile-controls').style.display = 'flex';
            music.play().catch(() => {});
        }
        
        function gameOver() { gameState = 0; save(); location.reload(); }
        function save() { data.selectedSkin = skins[curSkinIdx].name; localStorage.setItem(MASTER_KEY, JSON.stringify(data)); }
        function manualSave() { save(); alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); }
        function setControl(t) { data.controlType = t; document.getElementById('ctrl-pc').className = t==='pc'?'arrow-btn active':'arrow-btn'; document.getElementById('ctrl-mobile').className = t==='mobile'?'arrow-btn active':'arrow-btn'; save(); }
        
        function buyUpgrade(u) { 
            if(u === 'multiplier' && data.upgrades.multiplier > 0) return;
            if(u === 'magnet' && data.upgrades.magnet > 0) return;
            let c = u==='magnet'?50:100; 
            if(data.wallet >= c) { 
                data.wallet -= c; 
                data.upgrades[u]++; 
                updateUI(); save(); 
            } 
        }

        function changeSkin(d) { curSkinIdx = (curSkinIdx + d + skins.length) % skins.length; updateUI(); updateModel(); }
        function changeWorld(d) { curWorldIdx = (curWorldIdx + d + worlds.length) % worlds.length; updateWorld(); }
        function updateWorld() { const w = worlds[curWorldIdx]; renderer.setClearColor(w.sky); road.material.color.setHex(w.road); while(bgGroup.children.length > 0) bgGroup.remove(bgGroup.children[0]); for(let i=0; i<150; i++){ const z = -20 - Math.random()*70; let m; if(w.theme === "suburb") m = new THREE.Mesh(new THREE.BoxGeometry(8, 14, 6), new THREE.MeshStandardMaterial({color: 0x332211})); else if(w.theme === "mall") m = new THREE.Mesh(new THREE.BoxGeometry(2, 35, 2), new THREE.MeshStandardMaterial({color: 0x111111, emissive: i%2?0x00ffff:0xff00ff})); else m = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 3.5, 45), new THREE.MeshStandardMaterial({color: 0x110000})); m.position.set(Math.random()*3000-1500, 0, z); bgGroup.add(m); } updateUI(); }
        
        function updateUI() { 
            const s = skins[curSkinIdx]; 
            const w = worlds[curWorldIdx]; 
            document.getElementById('skin-name').innerText = s.name; 
            document.getElementById('world-name').innerText = w.name; 
            document.getElementById('world-diff-label').innerText = w.diff; 
            document.getElementById('wallet-balance').innerText = data.wallet; 
            document.getElementById('main-btn').innerText = data.owned.includes(s.name) ? "–ò–ì–†–ê–¢–¨" : `–ö–£–ü–ò–¢–¨ –ó–ê ${s.price}`;
            
            // –õ–û–ì–ò–ö–ê –ò–°–ß–ï–ó–ù–û–í–ï–ù–ò–Ø –ö–ù–û–ü–û–ö –ü–û–°–õ–ï –ü–û–ö–£–ü–ö–ò
            if(data.upgrades.multiplier > 0) {
                document.getElementById('row-multiplier').style.display = 'none';
            }
            if(data.upgrades.magnet > 0) {
                document.getElementById('row-magnet').style.display = 'none';
            }
        }

        function setupTabs() { ['heroes', 'shop', 'settings', 'inv'].forEach(t => document.getElementById('btn-'+t).onclick = (e) => { ['heroes', 'shop', 'settings', 'inv'].forEach(v => { document.getElementById('view-'+v).classList.add('hidden'); document.getElementById('btn-'+v).classList.remove('active'); }); document.getElementById('view-'+t).classList.remove('hidden'); e.target.classList.add('active'); if(t==='inv') renderInv(); }); }
        function renderInv() { const list = document.getElementById('collection-list'); list.innerHTML = ''; skins.forEach((s, idx) => { if(data.owned.includes(s.name)) { const card = document.createElement('div'); card.className = `skin-card ${skins[curSkinIdx].name === s.name ? 'selected' : ''}`; card.innerHTML = `<b>${s.name}</b>`; card.onclick = () => { curSkinIdx = idx; updateUI(); updateModel(); renderInv(); }; list.appendChild(card); }}); }
        window.onkeydown = (e) => { if(e.code === 'Space') tryJump(); if(e.code === 'KeyE') useAbility(); };
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        
        init();
    </script>
</body>
</html>